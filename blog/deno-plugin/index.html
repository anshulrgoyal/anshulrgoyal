<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.3">
<link rel="alternate" type="application/rss+xml" href="/anshulrgoyal/blog/rss.xml" title="Anshul Goyal Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/anshulrgoyal/blog/atom.xml" title="Anshul Goyal Blog Atom Feed"><title data-react-helmet="true">How to create a Deno plugin in Rust | Anshul Goyal</title><meta data-react-helmet="true" property="og:title" content="How to create a Deno plugin in Rust | Anshul Goyal"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="description" content="Deno is a new JavaScript runtime built with Rust and V8 that enables you to run JavaScript outside the browser. Deno is more secure than Node.js because it limits network and file system access by default."><meta data-react-helmet="true" property="og:description" content="Deno is a new JavaScript runtime built with Rust and V8 that enables you to run JavaScript outside the browser. Deno is more secure than Node.js because it limits network and file system access by default."><meta data-react-helmet="true" property="og:url" content="https://anshulrgoyal.github.io/anshulrgoyal/blog/deno-plugin"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:image" content="https://blog.logrocket.com/wp-content/uploads/2021/06/deno-rust-plugin.png"><meta data-react-helmet="true" name="twitter:image" content="https://blog.logrocket.com/wp-content/uploads/2021/06/deno-rust-plugin.png"><link data-react-helmet="true" rel="shortcut icon" href="/anshulrgoyal/img/anshul.jpg"><link data-react-helmet="true" rel="canonical" href="https://anshulrgoyal.github.io/anshulrgoyal/blog/deno-plugin"><link data-react-helmet="true" rel="alternate" href="https://anshulrgoyal.github.io/anshulrgoyal/blog/deno-plugin" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://anshulrgoyal.github.io/anshulrgoyal/blog/deno-plugin" hreflang="x-default"><link rel="stylesheet" href="/anshulrgoyal/assets/css/styles.056d3a92.css">
<link rel="preload" href="/anshulrgoyal/assets/js/runtime~main.113fc30b.js" as="script">
<link rel="preload" href="/anshulrgoyal/assets/js/main.56fd1749.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?t("light"):t("dark")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><div class="announcementBar_3WsW" role="banner"><div class="announcementBarContent_3EUC announcementBarCloseable_3myR">I am looking for a JOB.</div><button type="button" class="announcementBarClose_38nx clean-btn" aria-label="Close"><span aria-hidden="true">Ã—</span></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/anshulrgoyal/"><b class="navbar__title">Anshul Goyal</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/anshulrgoyal/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/anshulrgoyal/projects">Conributions</a><a href="https://github.com/anshulrgoyal" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--checked react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" checked="" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/anshulrgoyal/"><b class="navbar__title">Anshul Goyal</b></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/anshulrgoyal/projects">Conributions</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/anshulrgoyal/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/anshulrgoyal" target="_blank" rel="noopener noreferrer" class="menu__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a aria-current="page" class="sidebarItemLink_1RT6 sidebarItemLinkActive_12pM" href="/anshulrgoyal/blog/deno-plugin">How to create a Deno plugin in Rust</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/anshulrgoyal/blog/macro-rust">An intro to macros in rust</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/anshulrgoyal/blog/mlh-fellowship">MLH Fellowship: A new way of learning</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/anshulrgoyal/blog/easy-documentation-docusaurus">Easy Documentation using Docusaurus</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/anshulrgoyal/blog/rust-auth-lib">The state of Rust: Authorization/authentication libraries</a></li></ul></nav></aside><main class="col col--7"><article><header><h1 class="blogPostTitle_GeHD">How to create a Deno plugin in Rust</h1><div class="blogPostData_291c margin-vert--md"><time datetime="2021-06-24T00:00:00.000Z">June 24, 2021</time> Â· 7 min read</div><div class="avatar margin-vert--md"><a href="https://github.com/anshulrgoyal" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="/img/anshul.jpg" alt="Anshul Goyal"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/anshulrgoyal" target="_blank" rel="noopener noreferrer">Anshul Goyal</a></div><small class="avatar__subtitle"></small></div></div></header><div class="markdown"><p>Deno is a new JavaScript runtime built with Rust and V8 that enables you to run JavaScript outside the browser. <a href="https://blog.logrocket.com/what-is-deno/" target="_blank" rel="noopener noreferrer">Deno is more secure than Node.js</a> because it limits network and file system access by default. </p><p>One of the cool things about Deno is that it enables you to write and use plugins written in Rust within Deno code. This works thanks to plugins, which can also be written in Rust.</p><p>In this tutorial, weâ€™ll show you how to create Deno plugins in Rust. Weâ€™ll cover the following:</p><ul><li><a href="https://paper.dropbox.com/doc/How-to-create-a-Deno-plugin-in-Rust--BL3wF7W8gXJh4XBumWI1K_9xAg-UDzW8fsLUigxSvaZJMh7r#:uid=744656682274102420634231&amp;h2=Why-write-Deno-plugins-in-Rust" target="_blank" rel="noopener noreferrer">Why write Deno plugins in Rust?</a></li><li><a href="https://paper.dropbox.com/doc/How-to-create-a-Deno-plugin-in-Rust--BL3wF7W8gXJh4XBumWI1K_9xAg-UDzW8fsLUigxSvaZJMh7r#:uid=212989478249355405870882&amp;h2=Deno-plugin-project-structure" target="_blank" rel="noopener noreferrer">Deno plugin project structure</a></li><li><a href="https://paper.dropbox.com/doc/How-to-create-a-Deno-plugin-in-Rust--BL3wF7W8gXJh4XBumWI1K_9xAg-UDzW8fsLUigxSvaZJMh7r#:h2=Building-a-Rust-project" target="_blank" rel="noopener noreferrer">Building a Rust project</a></li><li><a href="https://paper.dropbox.com/doc/How-to-create-a-Deno-plugin-in-Rust--BL3wF7W8gXJh4XBumWI1K_9xAg-UDzW8fsLUigxSvaZJMh7r#:uid=717384026671171805848518&amp;h2=Adding-Rust-code" target="_blank" rel="noopener noreferrer">Adding Rust code</a></li><li><a href="https://paper.dropbox.com/doc/How-to-create-a-Deno-plugin-in-Rust--BL3wF7W8gXJh4XBumWI1K_9xAg-UDzW8fsLUigxSvaZJMh7r#:h2=Creating-the-optimizer-functio" target="_blank" rel="noopener noreferrer">Creating the optimizer function</a></li><li><a href="https://paper.dropbox.com/doc/How-to-create-a-Deno-plugin-in-Rust--BL3wF7W8gXJh4XBumWI1K_9xAg-UDzW8fsLUigxSvaZJMh7r#:h2=Loading-a-Rust-plugin-in-Deno" target="_blank" rel="noopener noreferrer">Loading a Rust plugin in Deno</a></li><li><a href="https://paper.dropbox.com/doc/How-to-create-a-Deno-plugin-in-Rust--BL3wF7W8gXJh4XBumWI1K_9xAg-UDzW8fsLUigxSvaZJMh7r#:h2=Writing-async-plugins" target="_blank" rel="noopener noreferrer">Writing async plugins</a></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="why-write-deno-plugins-in-rust"></a>Why write Deno plugins in Rust?<a class="hash-link" href="#why-write-deno-plugins-in-rust" title="Direct link to heading">#</a></h2><p>Plugins in Deno generally provide better performance and provide access to a wider range of tools. </p><p>Due to their performant nature, plugins are often used to perform calculations for heavy tasks such as image processing. Plugins also give you access to a variety of libraries written in other languages, including high-quality Rust crates.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="deno-plugin-project-structure"></a>Deno plugin project structure<a class="hash-link" href="#deno-plugin-project-structure" title="Direct link to heading">#</a></h2><p>The plugin project structure is the same as any Deno module. For project structure, you can use <a href="https://github.com/BrunnerLivio/deno-module-starter" target="_blank" rel="noopener noreferrer">this boilerplate</a>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">git clone https://github.com/anshulrgoyal/deno-rust-starter.git my_module</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>First, build the Rust boilerplate for the plugin:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">cd my_module/native</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cargo build</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Next, run a test to verify that Deno is picking up the correct library:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">cd my_module/native</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">deno test --unstable --allow-plugin</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The boilerplate includes a Rust project in the <code>native</code> directory and a Deno module in the root.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="building-a-rust-project"></a>Building a Rust project<a class="hash-link" href="#building-a-rust-project" title="Direct link to heading">#</a></h2><p>The Rust project compiles a dynamic library that is loaded by the Deno runtime. The file type and name of the library depends on the operating system. The Rust project may compile to a <code>so</code> file â€”  <code>dylib</code> or <code>dll</code> â€” and the name of the compiled file may also be different. The boilerplate can handle three major platforms: Linux, macOS, and Windows.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">[package]</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">name = &quot;native&quot;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">version = &quot;0.1.0&quot;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">authors = [&quot;anshul &lt;anshulgoel151999@gmail.com&gt;&quot;]</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">edition = &quot;2018&quot;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[lib]</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">name = &quot;native&quot;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">crate-type = [&quot;cdylib&quot;]</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[dependencies]</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">deno_core = &quot;0.75.0&quot;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">â”œâ”€â”€ README.md</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">â”œâ”€â”€ deps.ts</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">â”œâ”€â”€ mod.ts</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">â”œâ”€â”€ mod_test.ts</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">â”œâ”€â”€ native</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">â”‚   â”œâ”€â”€ Cargo.lock</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">â”‚   â”œâ”€â”€ Cargo.toml</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">â”‚   â”œâ”€â”€ src</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">â”‚       â””â”€â”€ lib.rs</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">â”œâ”€â”€ test.ts</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">â”œâ”€â”€ test_deps.ts</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">â””â”€â”€ tsconfig.json</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The <code>mod.ts</code> file is the main file imported by another application using your module.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="adding-rust-code"></a>Adding Rust code<a class="hash-link" href="#adding-rust-code" title="Direct link to heading">#</a></h2><p>For this tutorial, weâ€™ll show you how to build a PNG optimizer using an <code>oxipng</code> crate. Every Deno plugin must export the <code>deno_plugin_init</code> function and register all the methods that the plugin exports.</p><p>The <code>#[no_mangle]</code> attribute tells the compiler not to change the name of the function:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">#[no_mangle]</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">pub fn deno_plugin_init(interface: &amp;mut dyn Interface) {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> // register the function. Pass name and function to register method</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    interface.register_op(&quot;hello_world&quot;,hello_world);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="creating-the-optimizer-function"></a>Creating the optimizer function<a class="hash-link" href="#creating-the-optimizer-function" title="Direct link to heading">#</a></h2><p>Each exported function has the same signature. Deno plugins can only export functions. These functions can be sync or async, depending on the return type.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">fn optimise(_interface: &amp;mut dyn Interface,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    zero_copy: &amp;mut [ZeroCopyBuf],</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">) -&gt; Op {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // get first argument</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    let first=zero_copy.first().unwrap();</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    let opts: oxipng::Options = Default::default();</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // convert vector</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    let result = oxipng::optimize_from_memory(&amp;first.to_vec(), &amp;opts).unwrap();</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    // move to heap so that deno can use it</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Op::Sync(Box::from(result))</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The second argument of the function contains an array of buffers. Each buffer in the array represents the argument passed to the exported function when called. These buffers are serialized to strings or other data types based on requirements. </p><p>The above code takes the first element of <code>zero_copy</code> and passes it to <code>optimize_from_memory</code>. The first element of the array is the file passed to the <code>optimize</code> function when called from the Deno code. The file is passed as bytes. The function processes the file and returns the result as a <code>Box</code>. The return type is <code>Op</code> enum with two variants <code>sync</code> and <code>async</code>.</p><p>Build the code using the <code>cargo build</code> command. Now this plugin can be used in Deno.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="loading-a-rust-plugin-in-deno"></a>Loading a Rust plugin in Deno<a class="hash-link" href="#loading-a-rust-plugin-in-deno" title="Direct link to heading">#</a></h2><p>Now that the plugin is compiled, letâ€™s load it using Deno. </p><p>The plugin is still in development and is a part of unstable APIs, so the <code>--unstable</code> flag is required, as is <code>--allow-plugin</code>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">let path = &quot;&quot;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// check the type of OS to load correct file</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">if (Deno.build.os === &quot;linux&quot;) {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// linux file emited by rust compiler</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  path = &quot;./native/target/debug/libnative.so&quot;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">} else if (Deno.build.os === &quot;windows&quot;) {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// windows file emited by rust compiler</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  path = &quot;./native/target/debug/native.dll&quot;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">} else if (Deno.build.os === &quot;darwin&quot;) {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// macos file emited by rust comipler</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  path = &quot;./native/target/debug/libnative.dylib&quot;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// load plugin from file system</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">const rid = Deno.openPlugin(path);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// Get available methods on plugin</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">//@ts-Expect-Error</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">const { optimise:optimise_native } = (Deno as any).core.ops();</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">export async function optimise(fileName: string): Promise&lt;Uint8Array&gt; {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// reading a file</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  const file = await Deno.open(fileName);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// getting content</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  const value = await Deno.readAll(file)</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// closing file</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  await Deno.close(file.rid)</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// running the native plugin method using Deno dispatch method</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  return (Deno as any).core.dispatch(optimise_native, value)</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Each plugin is loaded using the <code>openPlugin</code> method. Then, the <code>ops</code> method is used to get the method identifier, which executes the code exported by the plugin.</p><p><code>dispatch</code> is used to run code exported by the native plugin. The first argument is the method identifier; the rest are passed for the native function. In this case, the file is passed.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="writing-async-plugins"></a>Writing async plugins<a class="hash-link" href="#writing-async-plugins" title="Direct link to heading">#</a></h2><p>Since Deno is single-threaded, itâ€™s not wise to block the main thread. Deno allows you to return a future from the native function, which you can use with OS threads to write a function that doesnâ€™t block the main thread.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">fn optimise_async(_interface: &amp;mut dyn Interface,</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    zero_copy: &amp;mut [ZeroCopyBuf],</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">) -&gt; Op {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// get first argument</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    let first=zero_copy.first().unwrap();</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    let opts: oxipng::Options = Default::default();</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    let arg=first.to_vec();</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// create a new future</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    let fut = async move {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// create a channel to send result once done to main thread</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        let (tx, rx) = futures::channel::oneshot::channel::&lt;oxipng::PngResult&lt;Vec&lt;u8&gt;&gt;&gt;();</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// create a new thread</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        std::thread::spawn(move || {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// perform work</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          let result = oxipng::optimize_from_memory(&amp;arg, &amp;opts);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// send result to main thread</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          tx.send(result).unwrap();</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        });</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// receive the result</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        let result=rx.await;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// create a boxed slice</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        let result_box = result.unwrap().unwrap().into_boxed_slice();</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// return boxed slice from the future</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        result_box</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      };</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// return the future</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Op::Async(fut.boxed())</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>A future is created using the <code>async</code> block and returned as a boxed future. Deno handles the completion of the future and informs the Deno side of the plugin. A channel is used to communicate between the new thread and the main thread.</p><p>The Deno code doesnâ€™t need much updating â€” just a new <code>asyncHandler</code> to handle the completion of the task:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#F8F8F2"><span class="token plain">let path = &quot;&quot;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">if (Deno.build.os === &quot;linux&quot;) {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  path = &quot;./native/target/debug/libnative.so&quot;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">} else if (Deno.build.os === &quot;windows&quot;) {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  path = &quot;./native/target/debug/native.dll&quot;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">} else if (Deno.build.os === &quot;darwin&quot;) {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  path = &quot;./native/target/debug/libnative.dylib&quot;</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">const rid = Deno.openPlugin(path);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">const { optimise_async } = (Deno as any).core.ops();</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">export async function optimise(fileName: string){</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  const file = await Deno.open(fileName);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  const value = await Deno.readAll(file);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  await Deno.close(file.rid);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// new handler</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  (Deno as any).core.setAsyncHandler(optimise_async, (response:any) =&gt; {</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Deno.writeFile(&quot;l.png&quot;,response)</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  });</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// executing the native code.</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  (Deno as any).core.dispatch(optimise_async,value);</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">await optimise(&quot;t.png&quot;)</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">await Deno.close(rid);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="conclusion"></a>Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h2><p>In this tutorial, we covered how to build a simple Deno plugin using Rust as well as how to create an async plugin using Rust futures and the <code>deno_core</code> crate. </p><p>Rust has a large ecosystem with high-quality crates. You can use all these crates in Deno by creating plugins. Whether it&#x27;s an image processing plugin, database connector, etc., access to Rust plugins helps to expand the Deno ecosystem.</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_3kfx"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/anshulrgoyal/blog/tags/rust">rust</a><a class="margin-horiz--sm" href="/anshulrgoyal/blog/tags/deno">deno</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/anshulrgoyal/blog/macro-rust"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">An intro to macros in rust Â»</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#why-write-deno-plugins-in-rust" class="table-of-contents__link">Why write Deno plugins in Rust?</a></li><li><a href="#deno-plugin-project-structure" class="table-of-contents__link">Deno plugin project structure</a></li><li><a href="#building-a-rust-project" class="table-of-contents__link">Building a Rust project</a></li><li><a href="#adding-rust-code" class="table-of-contents__link">Adding Rust code</a></li><li><a href="#creating-the-optimizer-function" class="table-of-contents__link">Creating the optimizer function</a></li><li><a href="#loading-a-rust-plugin-in-deno" class="table-of-contents__link">Loading a Rust plugin in Deno</a></li><li><a href="#writing-async-plugins" class="table-of-contents__link">Writing async plugins</a></li><li><a href="#conclusion" class="table-of-contents__link">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">About</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/anshulrgoyal/projects">Contributions</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://dev.to/anshulgoyal15/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Dev.to<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://medium.com/@ar_goyal" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Medium<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/anshul-goyal-8aa479135/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Linkedin<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/ar_goyal" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/anshulrgoyal/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/anshulrgoyal" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Anshul Goyal. Built with Docusaurus.</div></div></div></footer></div>
<script src="/anshulrgoyal/assets/js/runtime~main.113fc30b.js"></script>
<script src="/anshulrgoyal/assets/js/main.56fd1749.js"></script>
</body>
</html>